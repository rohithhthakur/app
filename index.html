#!/bin/bash

# Configuration variables
TOWER_URL="https://your.ansible.tower.url"
USERNAME="your_username"
PASSWORD="your_password"

# Encode credentials for basic authentication
BASIC_AUTH=$(echo -n "$USERNAME:$PASSWORD" | base64)

# Get date three days ago (GNU date format)
THREE_DAYS_AGO=$(date --date="3 days ago" +"%Y-%m-%dT%H:%M:%S")

# Fetch all successful jobs
response=$(curl -s "$TOWER_URL/api/v2/jobs/?status=successful" \
   -H "Authorization: Basic $BASIC_AUTH" \
   -H "Accept: application/json")

# Check if the curl command was successful
if [ $? -ne 0 ]; then
    echo "Failed to fetch jobs from Ansible Tower"
    exit 1
fi

# Parse job IDs and their finished times using jq
jobs=$(echo $response | jq -c '.results[] | select(.finished < "'$THREE_DAYS_AGO'") | {id: .id, finished: .finished}')

# Check if no jobs are found
if [ -z "$jobs" ]; then
    echo "No successful jobs older than three days to delete."
    exit 0
fi

# Delete each successful job older than three days
echo "$jobs" | jq -r '.id' | while read JOB_ID; do
    echo "Deleting job ID: $JOB_ID"
    delete_response=$(curl -s -X DELETE "$TOWER_URL/api/v2/jobs/$JOB_ID/" \
        -H "Authorization: Basic $BASIC_AUTH" \
        -H "Content-Type: application/json")

    # Check response for errors
    if echo "$delete_response" | jq '.error' &> /dev/null; then
        echo "Failed to delete job ID $JOB_ID: $(echo $delete_response | jq -r '.error_description')"
    else
        echo "Successfully deleted job ID $JOB_ID"
    fi
done