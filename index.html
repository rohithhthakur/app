# Existing parameter checks
if "output_format" in os.environ:
    output_format = os.environ['output_format']
else:
    output_format = "csv"

# New parameter check
if "new_cona" in os.environ:
    new_cona = os.environ['new_cona'].lower() in ['true', '1', 't', 'y', 'yes']
else:
    new_cona = False

# Updated Popen call with new_cona parameter
model = Popen(f"python3 /app/unit_overlay/scripts/unit_overlays_coaf_alm_3.py {snowflake_userid} {MyUniqueKey} {overlay_rules_file} {summary_model_output_file} {output_format} {mount_path} {new_cona}", shell=True)

# Rest of your existing code
monitor = Popen('bash {input_path}monitor_process.sh python15s {output_path}overlays_monitor.csv'.format(input_path=mount_path, output_path=mount_path), shell=True)
model.wait()
ret_code = model.returncode
monitor.terminate()

return ret_code

class UnitOverlay:
    def __init__(self, rules_file, model_file, output_format, new_cona=False):
        self.rules_file = rules_file
        self.model_file = model_file
        self.output_format = output_format
        self.new_cona = new_cona  # Boolean, controls the behavior in generate_allm_avf_cona
        self.min_horizon = None
        self.group = False
        
        
        
def generate_allm_avf_cona(self):
    print("Generating CONA file...")
    if self.new_cona:
        # Assume df is already loaded somewhere in the class
        columns_to_remove = ['column1', 'column2']  # Replace with actual columns to remove
        allm_avf_cona = self.df.copy(deep=True).drop(columns=columns_to_remove)
    else:
        # Existing logic using the internal DataFrame
        allm_avf_cona = self.df.copy(deep=True)
        # Apply your existing transformations
        allm_avf_cona['nonbk_unit'] = allm_avf_cona['pd_repo'] + allm_avf_cona['pd_od']  # Continue with other operations

    # Renaming and filling NaN values, consistent with existing logic
    rename_dict = {'segment': 'seg', 'rcvr_month': 'monthend'}
    allm_avf_cona.rename(columns=rename_dict, inplace=True)
    allm_avf_cona.fillna(0)

    # Groupby and aggregation logic
    print("Groupby and Summing over cols...")
    allm_avf_cona = allm_avf_cona.groupby(['segment', 'monthend']).agg({
        'nonbk_gd': 'sum',
        # Add other columns to aggregate here
    }).rename(columns={'nonbk_gd': 'sum_nonbk_gd'})

    allm_avf_cona.reset_index(inplace=True)
    print("Created CONA file")
    print(allm_avf_cona.head())
    return allm_avf_cona
